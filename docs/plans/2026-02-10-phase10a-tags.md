# Phase 10a: Tags & Tag Categories Implementation Plan

**Date:** 2026-02-10
**Status:** Draft
**Scope:** `vrg tag` commands — tag CRUD with member assignment, tag category CRUD
**Dependencies:** None
**Task Checklist:** Bottom of file — `tail -20` to check status

## SDK Reference

| CLI concept | SDK manager (`client.<name>`) | SDK source file |
|-------------|-------------------------------|-----------------|
| Tags | `tags` | `/Users/larry/Development/pyvergeos/pyvergeos/resources/tags.py` |
| Tag Categories | `tag_categories` | `/Users/larry/Development/pyvergeos/pyvergeos/resources/tags.py` |

**SDK example:** `/Users/larry/Development/pyvergeos/examples/tag_management_example.py`

---

## Overview

Add resource tagging commands. VergeOS tags are organized hierarchically: **Tag Categories** contain **Tags**, and tags are assigned to resources via **Tag Members**. Categories define which resource types can be tagged (VMs, networks, nodes, etc.).

**Key details:**
- Tags and categories both use integer keys
- Tags are scoped to a category — tag names must be unique within a category
- `get()` supports lookup by name + category: `tags.get(name="prod", category_name="Environment")`
- Tag member assignment uses a sub-manager: `tag.members.add(resource_type, resource_key)`
- The `assign`/`unassign` commands need to resolve both the tag and the target resource
- Tag categories have many boolean `taggable_*` flags controlling which resource types can be tagged

**Reference implementations:** `recipe.py` for CRUD, `tenant_snapshot.py` for sub-resource pattern.

## Commands

```
vrg tag list [--filter ODATA] [--category CATEGORY]
vrg tag get <ID|NAME> [--category CATEGORY]
vrg tag create --name NAME --category CATEGORY [--description DESC]
vrg tag update <ID|NAME> [--name NAME] [--description DESC]
vrg tag delete <ID|NAME> [--yes]
vrg tag assign <TAG> <RESOURCE_TYPE> <RESOURCE_ID>
vrg tag unassign <TAG> <RESOURCE_TYPE> <RESOURCE_ID>
vrg tag members <TAG> [--type RESOURCE_TYPE]
vrg tag category list [--filter ODATA]
vrg tag category get <ID|NAME>
vrg tag category create --name NAME [--description DESC] [--single-selection] [--taggable-vms] [--taggable-networks] [--taggable-nodes] [--taggable-tenants] [--taggable-users] [--taggable-clusters] [--taggable-sites] [--taggable-groups] [--taggable-volumes]
vrg tag category update <ID|NAME> [--name NAME] [--description DESC] [--single-selection BOOL] [--taggable-vms BOOL] [...]
vrg tag category delete <ID|NAME> [--yes]
```

### Command Details

#### `vrg tag list`

- Options:
  - `--filter` (str) — OData filter expression
  - `--category` (str) — filter by category name or key
- If `--category` is a name, resolve to key via `resolve_resource_id(client.tag_categories, category, "Tag category")`
- SDK: `tags.list(category_key=cat_key)` or `tags.list(category_name=cat_name)`

#### `vrg tag get`

- Positional: `TAG` (numeric key or name)
- `--category` (str) — required if looking up by name (names aren't globally unique)
- Resolution:
  - Numeric → `tags.get(key=int(tag))`
  - Name → `tags.get(name=tag, category_name=category)` or `tags.get(name=tag, category_key=cat_key)`
- If name lookup without `--category`, try `tags.get(name=tag)` — SDK may return first match or error

#### `vrg tag create`

- Required: `--name`, `--category` (category name or key)
- Optional: `--description`
- Resolve category: `resolve_resource_id(client.tag_categories, category, "Tag category")`
- SDK: `tags.create(name=name, category_key=cat_key, description=description)`

#### `vrg tag update`

- Positional: `TAG` (key or name)
- Optional: `--name`, `--description`
- SDK: `tags.update(key, name=name, description=description)`

#### `vrg tag delete`

- Positional: `TAG` (key or name)
- `--yes / -y` — skip confirmation
- SDK: `tags.delete(key)`

#### `vrg tag assign`

- Positional: `TAG` (tag name or key), `RESOURCE_TYPE` (vm/network/node/tenant/user/cluster/site/group), `RESOURCE_ID` (resource name or key)
- Steps:
  1. Resolve tag to key
  2. Get the tag's member manager: `tag_obj = client.tags.get(tag_key)`, then `tag_obj.members`
  3. Use typed helper if available: `tag_obj.members.add_vm(vm_key)`, `tag_obj.members.add_network(net_key)`, etc.
  4. Fallback: `tag_obj.members.add(resource_type, resource_key)`
- Valid resource types: vm, network, node, tenant, user, cluster, site, group
- SDK: `tag.members.add(resource_type=type, resource_key=key)` or typed `add_vm(key)`, etc.

#### `vrg tag unassign`

- Positional: `TAG` (tag name or key), `RESOURCE_TYPE`, `RESOURCE_ID`
- Steps:
  1. Resolve tag
  2. Use typed helper: `tag_obj.members.remove_vm(vm_key)`, etc.
  3. Fallback: `tag_obj.members.remove_resource(resource_type, resource_key)`
- SDK: `tag.members.remove_resource(resource_type=type, resource_key=key)` or typed `remove_vm(key)`, etc.

#### `vrg tag members`

- Positional: `TAG` (tag name or key)
- `--type` (str) — filter by resource type
- Lists all resources tagged with this tag
- SDK: `tag_obj.members.list(resource_type=type)`

#### `vrg tag category list`

- Options: `--filter` (str)
- SDK: `tag_categories.list()`

#### `vrg tag category get`

- Positional: `CATEGORY` (key or name)
- Resolution: `resolve_resource_id(client.tag_categories, identifier, "Tag category")`
- SDK: `tag_categories.get(key)`

#### `vrg tag category create`

- Required: `--name`
- Optional: `--description`, `--single-selection` (flag), plus `--taggable-*` flags for each resource type
- SDK: `tag_categories.create(name=..., single_tag_selection=..., taggable_vms=..., ...)`
- The taggable flags all default to False — only pass the ones explicitly provided

#### `vrg tag category update`

- Positional: `CATEGORY` (key or name)
- All fields optional — only update provided values
- SDK: `tag_categories.update(key, ...)`

#### `vrg tag category delete`

- Positional: `CATEGORY` (key or name)
- `--yes / -y` — skip confirmation
- SDK: `tag_categories.delete(key)`

### Resource Type Mapping

Map CLI-friendly names to SDK values for `assign`/`unassign`/`members`:

```python
RESOURCE_TYPE_MAP: dict[str, str] = {
    "vm": "vms",
    "network": "vnets",
    "node": "nodes",
    "tenant": "tenant_nodes",
    "user": "users",
    "cluster": "clusters",
    "site": "sites",
    "group": "groups",
    "volume": "volumes",
}
```

## Files

### New Files

1. **`src/verge_cli/commands/tag.py`** — Tag commands + tag category sub-command
   - Typer app with: list, get, create, update, delete, assign, unassign, members
   - Registers `tag_category.app` as sub-command `category`
   - Columns: `TAG_COLUMNS`, `TAG_MEMBER_COLUMNS`
   - Helpers: `_tag_to_dict()`, `_member_to_dict()`, `_resolve_tag()`, `_resolve_target_resource()`
   - Constant: `RESOURCE_TYPE_MAP`

2. **`src/verge_cli/commands/tag_category.py`** — Tag category CRUD
   - Columns: `TAG_CATEGORY_COLUMNS`
   - Helper: `_category_to_dict()`

3. **`tests/unit/test_tag.py`** — Tests for tag commands + assign/unassign

4. **`tests/unit/test_tag_category.py`** — Tests for tag category CRUD

### Modified Files

5. **`src/verge_cli/cli.py`**
   - Add: `from verge_cli.commands import tag`
   - Add: `app.add_typer(tag.app, name="tag")`

6. **`tests/conftest.py`**
   - Add `mock_tag` fixture
   - Add `mock_tag_category` fixture
   - Add `mock_tag_member` fixture

## Column Definitions

### TAG_COLUMNS

```python
TAG_COLUMNS: list[ColumnDef] = [
    ColumnDef("$key", header="Key"),
    ColumnDef("name"),
    ColumnDef("category_name", header="Category"),
    ColumnDef("description", wide_only=True),
    ColumnDef("created", format_fn=format_epoch, wide_only=True),
]
```

### TAG_MEMBER_COLUMNS

```python
TAG_MEMBER_COLUMNS: list[ColumnDef] = [
    ColumnDef("$key", header="Key"),
    ColumnDef("resource_type", header="Type"),
    ColumnDef("resource_key", header="Resource Key"),
    ColumnDef("resource_name", header="Resource Name"),
]
```

### TAG_CATEGORY_COLUMNS

```python
TAG_CATEGORY_COLUMNS: list[ColumnDef] = [
    ColumnDef("$key", header="Key"),
    ColumnDef("name"),
    ColumnDef("single_selection", header="Single Select", format_fn=format_bool_yn),
    ColumnDef("taggable_types", header="Taggable Types"),
    ColumnDef("description", wide_only=True),
    ColumnDef("created", format_fn=format_epoch, wide_only=True),
]
```

## Data Mappings

```python
def _tag_to_dict(tag: Any) -> dict[str, Any]:
    return {
        "$key": int(tag.key),
        "name": tag.name,
        "category_name": tag.category_name or "",
        "description": tag.description or "",
        "created": tag.created,
    }

def _member_to_dict(member: Any) -> dict[str, Any]:
    return {
        "$key": int(member.key),
        "resource_type": member.get("resource_type", ""),
        "resource_key": member.get("resource_key", ""),
        "resource_name": member.get("resource_name", ""),
    }

def _category_to_dict(cat: Any) -> dict[str, Any]:
    # Build a comma-separated list of taggable resource types
    taggable = []
    for attr in ["vms", "networks", "volumes", "nodes", "tenants",
                  "users", "clusters", "sites", "groups"]:
        if getattr(cat, f"taggable_{attr}", False):
            taggable.append(attr)
    return {
        "$key": int(cat.key),
        "name": cat.name,
        "description": cat.description or "",
        "single_selection": cat.is_single_tag_selection,
        "taggable_types": ", ".join(taggable) if taggable else "none",
        "created": cat.created,
    }
```

## Test Fixtures

```python
@pytest.fixture
def mock_tag() -> MagicMock:
    tag = MagicMock()
    tag.key = 5
    tag.name = "production"
    tag.description = "Production environment"
    tag.category_name = "Environment"
    tag.category_key = 1
    tag.created = 1707000000
    tag.modified = 1707000000
    tag.members = MagicMock()  # TagMemberManager
    return tag

@pytest.fixture
def mock_tag_category() -> MagicMock:
    cat = MagicMock()
    cat.key = 1
    cat.name = "Environment"
    cat.description = "Environment classification"
    cat.is_single_tag_selection = True
    cat.taggable_vms = True
    cat.taggable_networks = True
    cat.taggable_volumes = False
    cat.taggable_nodes = True
    cat.taggable_tenants = True
    cat.taggable_users = False
    cat.taggable_clusters = False
    cat.taggable_sites = False
    cat.taggable_groups = False
    cat.taggable_network_rules = False
    cat.taggable_vmware_containers = False
    cat.taggable_tenant_nodes = False
    cat.created = 1707000000
    cat.modified = 1707000000
    return cat

@pytest.fixture
def mock_tag_member() -> MagicMock:
    member = MagicMock()
    member.key = 10
    def mock_get(key: str, default: Any = None) -> Any:
        data = {
            "resource_type": "vms",
            "resource_key": 42,
            "resource_name": "web-server-01",
        }
        return data.get(key, default)
    member.get = mock_get
    return member
```

## Test Plan

| # | Test | Validates |
|---|------|-----------|
| 1 | `test_tag_list` | Lists tags |
| 2 | `test_tag_list_by_category` | `--category Environment` filter |
| 3 | `test_tag_get_by_key` | Get by numeric key |
| 4 | `test_tag_get_by_name` | Get by name with `--category` |
| 5 | `test_tag_create` | Create tag in category |
| 6 | `test_tag_update` | Update tag description |
| 7 | `test_tag_delete_confirm` | Delete with --yes |
| 8 | `test_tag_delete_no_confirm` | Delete without --yes aborts |
| 9 | `test_tag_assign_vm` | Assign tag to a VM |
| 10 | `test_tag_assign_network` | Assign tag to a network |
| 11 | `test_tag_unassign` | Unassign tag from resource |
| 12 | `test_tag_members` | List tagged resources |
| 13 | `test_tag_members_by_type` | `--type vm` filter |
| 14 | `test_category_list` | Lists tag categories |
| 15 | `test_category_get` | Get category by name |
| 16 | `test_category_create` | Create with taggable flags |
| 17 | `test_category_create_single_selection` | Create with --single-selection |
| 18 | `test_category_update` | Update category |
| 19 | `test_category_delete_confirm` | Delete with --yes |
| 20 | `test_category_not_found` | Resolution error (exit 6) |

## Task Checklist

- [x] Create `tag.py` with list, get, create, update, delete, assign, unassign, members commands
- [x] Create `tag_category.py` with list, get, create, update, delete commands
- [x] Register `tag_category` as sub-command of `tag`
- [x] Register `tag` in `cli.py`
- [x] Add `mock_tag`, `mock_tag_category`, `mock_tag_member` fixtures to `conftest.py`
- [x] Create `test_tag.py`
- [x] Create `test_tag_category.py`
- [x] Run `uv run ruff check && uv run mypy src/verge_cli && uv run pytest`
